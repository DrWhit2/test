<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monochrome RPG Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --c0:#0a0d12;  /* darkest */
      --c1:#1c2834;  /* dark */
      --c2:#6c91b1;  /* light */
      --c3:#d6eeff;  /* lightest */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--c0);color:var(--c3);
         font-family:'Press Start 2P', monospace;}

    img{image-rendering:pixelated; image-rendering: crisp-edges;}

    .viewport{position:fixed; inset:0; overflow:hidden; background:var(--c1);}
    .bg{position:absolute; inset:0; 
        background: url('https://picsum.photos/800/600') center/cover no-repeat;
        filter:grayscale(100%) contrast(180%) brightness(80%);}
    .viewport::after{content:""; position:absolute; inset:0; pointer-events:none;
        background:repeating-linear-gradient(0deg,
        rgba(255,255,255,.08),rgba(255,255,255,.08) 1px,
        transparent 1px, transparent 2px);}

    /* HUD */
    .hud{position:absolute; left:50%; transform:translateX(-50%);
         bottom:20px; width:min(900px, 94vw);}
    .dialog{display:grid; grid-template-columns: 96px 1fr; gap:10px;}

    .face{background:var(--c0); border:3px solid var(--c3); padding:6px;
          height:96px; display:grid; place-items:center}
    .face img{height:100%; width:auto}

    .box{position:relative; background:var(--c0);
         border:3px solid var(--c3); padding:10px; min-height:96px}
    .name{position:absolute; top:-12px; left:12px;
          background:var(--c0); padding:2px 6px; border:3px solid var(--c3);
          font-size:10px;}
    .text{min-height:60px; font-size:12px; line-height:1.6;}

    .inputbar{margin-top:8px; display:grid; grid-template-columns: 1fr auto; gap:6px}
    input[type=text]{width:100%; background:var(--c0); color:var(--c3);
          border:3px solid var(--c3); padding:8px; font:inherit; font-size:12px}
    .send{background:var(--c0); color:var(--c3); border:3px solid var(--c3);
          padding:8px 12px; font:inherit; cursor:pointer}
    .send:hover{background:var(--c1)}

    @media(max-width:720px){
      .dialog{grid-template-columns: 1fr}
      .face{height:72px}
      .text{font-size:10px}
    }
  </style>
</head>
<body>
  <div class="viewport">
    <div class="bg" id="bg"></div>

    <div class="hud">
      <div class="dialog">
        <div class="face" id="faceBox">
          <img src="https://picsum.photos/96/96" alt="face"/>
        </div>
        <div class="box">
          <div class="name" id="name">Oswald</div>
          <div class="text" id="text"></div>
          <div class="inputbar">
            <input id="input" type="text" placeholder="▶ 입력" autocomplete="off"/>
            <button class="send" id="send">보내기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const $=(q)=>document.querySelector(q);
const T=(ms)=>new Promise(r=>setTimeout(r,ms));

const state={
  endpoint: localStorage.getItem('endpoint')||'',
  name: localStorage.getItem('name')||'Oswald',
  face: localStorage.getItem('face')||'',
  bg: localStorage.getItem('bg')||'',
  sys: localStorage.getItem('sys')||'당신은 오스월드 화이트입니다. 절제되고 논리적으로 간결하게 답합니다.',
  few: localStorage.getItem('few')||'핵심만 말하죠. 요지는 무엇입니까?'
};

// 초기 적용
$('#name').textContent=state.name;
if(state.face) $('#faceBox').innerHTML=`<img src=\"${state.face}\" alt=\"face\">`;
if(state.bg) $('#bg').style.backgroundImage=`url('${state.bg}')`;

// 타자효과
async function typewrite(el,text,speed=12){
  el.textContent=''; for(let i=0;i<text.length;i++){
    el.textContent+=text[i]; await T(speed);
  }
}

// AI 호출 (엔드포인트 없으면 데모)
async function callAI(user){
  if(!state.endpoint){
    const canned=['전제부터 확인합시다.','관찰을 정리해 보세요.','대안은 두 개 이상입니다.','증거부터 제시하시죠.'];
    return canned[Math.floor(Math.random()*canned.length)];
  }
  const res=await fetch(state.endpoint,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      system:state.sys,
      examples:state.few.split('\\n').filter(Boolean).slice(0,8),
      messages:[{role:'system',content:`캐릭터명:${state.name}`},{role:'user',content:user}]
    })
  });
  if(!res.ok) throw new Error('API '+res.status);
  if(res.body && window.ReadableStream){
    const reader=res.body.getReader(); const dec=new TextDecoder(); let acc='';
    while(true){const {value,done}=await reader.read(); if(done) break;
      acc+=dec.decode(value,{stream:true});
      await typewrite($('#text'),`${state.name}: ${acc}`,4);}
    return acc.trim();
  }else{const data=await res.json(); return data.reply||'';}
}

// 전송 핸들러
async function send(){
  const v=$('#input').value.trim(); if(!v) return; $('#input').value='';
  await typewrite($('#text'),`▶ 당신: ${v}`,4);
  try{const a=await callAI(v); await typewrite($('#text'),`${state.name}: ${a}`,4);}
  catch(e){await typewrite($('#text'),`[오류] ${e.message}`,4);}
}
$('#send').onclick=send;
$('#input').addEventListener('keydown',e=>{if(e.key==='Enter') send();});

// 시작 인사
(async()=>{await typewrite($('#text'),`${state.name}: …`,60); await T(300);
await typewrite($('#text'),`${state.name}: 대화를 시작하시죠.`,12);})();
</script>
</body>
</html>

